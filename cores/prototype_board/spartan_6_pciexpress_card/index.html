<head>
<link rel="stylesheet" href="../../style.css" type="text/css">
</head>
<a href="javascript:history.go(-1)" onMouseOver="self.status=document.referrer;return true">Go Back</a>
<p align='right'><a href='spartan6_pcie.tar.gz'>Source code</a></p>
<body>
<div class="main">
 <div class="mid" id="dm">
  <div class="content" id="dmc">
   <h2>
    Details
   </h2>
   <p>
    Name: spartan6_pcie
    <br/>
    Created: Mar 17, 2013
    <br/>
    Updated: Aug  2, 2014
    <br/>
    SVN Updated: Jul 28, 2014
    
    
    
    
    
    
   </p>
   <h2>
    Other project properties
   </h2>
   <p>
    Category:
    
     Prototype board
    
    <br/>
    Language:
    
     VHDL
    
    <br/>
    Development status:
    
     Beta
    
    <br/>
    Additional info:
    <br/>
    WishBone Compliant: No
    <br/>
    License: LGPL
   </p>
   <div id="d_Overview">
    <h2>
     
     
     Overview
    </h2>
    <p id="p_Overview">
     This article describe the PCI express card with Xilinx Spartan 6 that i have made.
     <br/>
     The download section contains test applications in Xilinx ISE for the PCI express and DDR3 functions (All worked at first).
     <br/>
     I am still not an expert so what would be more interesting (Processor core, intensive applications like running Linux ) is still a on wish list . PCB's are available as well as source project in Altium Designer.
    </p>
   </div>
   <div id="d_Images">
    <h2>
     
     
     Images
    </h2>
    <p id="p_Images">
     javascript:alert('
     <img src="usercontent,img,1363548315" alt="Image1"/>
     ');
javascript:alert('
     <img src="usercontent,img,1363548355" alt="Image2"/>
     ');
javascript:alert('
     <img src="usercontent,img,1363548377" alt="Image3"/>
     ');
javascript:alert('
     <img src="usercontent,img,1363548402" alt="Image4"/>
     ');
javascript:alert('
     <img src="usercontent,img,1363548420" alt="Image5"/>
     ');
javascript:alert('
     <img src="usercontent,img,1363549026" alt="PCIe device"/>
     ');
    </p>
   </div>
   <div id="d_Part list">
    <h2>
     
     
     Part list
    </h2>
    <p id="p_Part list">
     *All resistor and capacitor are 0603 if size not specified
     <br/>
     *All resistor are either 0402 or 0603 size
     <br/>
     *All capacitor are either 0402 or 0603 or 1206
     <br/>
     *All components may be found on Mouser(1st choice) or Digikey , except FPGA and DDR3 Digikey only.
     <br/>
     *DNF : means Do not fit (for example  NCP303-LSN29 is not required for correct operation)
     <br/>
     IC1	FPGA Xilinx XC6SLX45T-4FGG484C
     <br/>
     IC2	VCCINT regulator ST1S31 (ST1S31PUR)
     <br/>
     IC3	VDD15 regulator ST1S31 (ST1S31PUR)
     <br/>
     IC4	RAM terminator VDD075 regulator LP2996 (LP2996MRX/NOPB)
     <br/>
     IC5	VCC33 DC jack regulator LD1085 (LD1085D2T33R)
     <br/>
     IC6	W25Q128 128Mbit Winbond flash memory (W25Q128FVEIG)
     <br/>
     IC7	IDT ICS844071 SATA PLL (844071AGLF)
     <br/>
     IC8	1Gbit Micron DDR3 DRAM MT41J64M16 (MT41J64M16JT-15E:G TR)
     <br/>
     IC9	Everlight  Photolink module PLR135_T7
     <br/>
     IC10	Everlight  Photolink module  PLT135_T7
     <br/>
     IC11	NCP303-LSN29 DNF
     <br/>
     Q1 	SATA 25Mhz Abracon ASEM or ASEMB 3.2x2.5x0.85
     <br/>
     Q2	User 50Mhz Abracon ASEM or ASEMB 3.2x2.5x0.85
     <br/>
     P1	PCIE card edge connector
     <br/>
     H1,H2	double row 40pin 2.0mm header connector
     <br/>
     J1	DC jack 3.5mm (Maybe found on Ebay..)
     <br/>
     H3	14pin right angle 2.54mm JTAG connector
     <br/>
     D1-D3	led 0603
     <br/>
     D0	led 0603
     <br/>
     SD1,SD2	500873-0806 Molex Transflash push-push
     <br/>
     SATA1,SATA2	5607-4200-SH 3M SATA Connector SMT RA
     <br/>
     L1	Inductor 2.2uH 4A Murata 2020 (LQH5BPN2R2NT0L)
     <br/>
     L2	Inductor 3.3uH 1.1A 0806 Taiyo Yudan(CKP20163R3M-T)
     <br/>
     R1	VCCINT_GND 15K
     <br/>
     R2	VCCINT_PLUS 7.5K
     <br/>
     R3	VDD15_GND 18K
     <br/>
     R4	VDD15_PLUS 15.8K
     <br/>
     R5,R6	100R output of sata crystal
     <br/>
     R7	DO NOT FIT (can be 100R/0402 parallele resistor on pcie clock pair, but not nescessary)
     <br/>
     R8	330R DONE to VCC33
     <br/>
     R9	4K7 PROGRAM_B to VCC33
     <br/>
     R10	10K CMPCS_B to VCC33
     <br/>
     R11	4K7 INIT_B to VCC33
     <br/>
     R12-R14	680R led resistor 0402
     <br/>
     R15	240R 1% 0402 DRAM ZQ
     <br/>
     R16	50R GTP RCAL 0402
     <br/>
     R17-R18 4K7 0402 DDR CKE and Reset to GND
     <br/>
     R19	10K SPI SS to VCC33 0402
     <br/>
     R20	Swap enable 0R 0603
     <br/>
     R21,R22 SD2 unused pins 22K 0402
     <br/>
     R23	680R power led 0402
     <br/>
     R24,R25 SD1 unused pins 22K 0402
     <br/>
     R26,R27 pullup flash HOLD,WP 0402 10K
     <br/>
     R28	IO_DDR_TERM calibration resistor 100R 0402
     <br/>
     R29	DDR_CS tied to Gnd 0R 0402
     <br/>
     C1	Capacitor1206 VCC33 to VCCINT switch input 100uF
     <br/>
     C2	Capacitor1206 VCC33 to VDD15 switch input 100uF
     <br/>
     C3,C3b	Capacitor1206 VCCINT switch 100uF
     <br/>
     C4	Capacitor1206 VDD15 switch 100uF
     <br/>
     C5,C6	LP2996 100uF VDD075 output decoupl.
     <br/>
     C7	LP2996 VREF decoupl. 10nF
     <br/>
     C8	LP2996 VDD15 ref input decoupl. 10nF
     <br/>
     C9	47uF 0805 VCC33 to LP2996 power input
     <br/>
     C10,C11	50uF 1206 input to LD1085 regulator
     <br/>
     C12,C13 100uF 1206 output of LD1085
     <br/>
     C14 	100nF output of SATA crystal
     <br/>
     C15,C16	SATA REFCLK diff pair Capacitor0402 100nF
     <br/>
     C17-C20 SATA1 RX/TX capacitor 0402 10nF
     <br/>
     C21-C24	SATA2 RX/TX capacitor 0402 10nF
     <br/>
     C25-C28 PCIE RX/TX capacitor 0402 100nF
     <br/>
     C29	1nF NCP303
     <br/>
     C30-C31 decoupling TOS RX/TX 100nF
     <br/>
     C32 decoupling flash memory 100nF
     <br/>
     C33 decoupling Q2 user 50Mhz oscillator(0402 size)
     <br/>
     C34 decoupling Q1 sata 25Mhz oscillator(0402 size)
     <br/>
     C35 decoupling SATA PLL ICS844071 (0603 size)
     <br/>
     C40-C42 100nF VDD075 decoupling RAM
     <br/>
     C45-C46 100nF VDD075 decoupling FPGA
     <br/>
     C50-C56	1uF GTP decoupling
     <br/>
     C60-C65 1uF VDD15 decoupling FPGA
     <br/>
     C70-C74	1uF VCCINT decoupling
     <br/>
     C80-C93 1uF VCCAUX/VCCO/VCC33 FPGA decoupling
     <br/>
     C100-C109 1uF VDD15 decoupling RAM
     <br/>
     C120 decoupling SD2 100nF 0402
     <br/>
     C121 decoupling SD1 100nF 0402
     <br/>
    </p>
   </div>
   <div id="d_Article">
    <h2>
     
     
     Article
    </h2>
    <p id="p_Article">
     I have designed and built a PCI express extension card with Spartan 6 FPGA.
     <br/>
     I was very attracted in testing Microprocessor cores in FPGA and also PC extension cards.
     <br/>
     So i needed a board with RAM, non volatile memory (SDHC memory cards) and FPGA.
     <br/>
     When i saw the selling price of this kind of cards, i decided to build mine. Also it was a good exercise to conduct the fabrication of this card from schematic and PCB up to assembling.
     <br/>
     Many features where new to me:
     <br/>
     -High speed differential pair
     <br/>
     -Length matching and resistor terminations for DDR3
     <br/>
     -big FPGA chips (DDR3 and FPGA)
     <br/>
     So i have read carefully the design recommendation from the Manufacturers (Xilinx for FPGA and Micron for the DDR3). I got documented also on the Freescale IMX35 processor reference design .   All recommended to carefully control PCB impedance , differential pair length matching, DDR3 signals length matching and termination resistors on high speed signals.
     <br/>
     I had a new tool for PCB design (Altium designer) that made the task a lot easy or at least possible .
     <br/>
     Anyway some problems came arise concerning  the price of fine PCB manufacture:
     <br/>
     First i designed a 8 layer PCB that accomplished impedance parameter of 50ohm on single ended signals and of course 100ohm on differential pairs. Moreover , the DDR signals where well separated each other with 2.5 x trace width that is recommended by Xilinx. But the PCB parameters where expensive to manufacture (traces of 0.1mm / vias of 0.4mm / 8 layers ) was 500USD cost for 10pcs.
     <br/>
     I decided then to reduce cost , with only 4 layer (DDR traces where now shielded with only the top and bottom layer which are ground and power planes but with some discontinuity). Moreover i enlarged minimum trace width to become 0.15mm and via size to become 0.5mm.
     <br/>
     With these parameters , impedance rule of 50R/100R is not really respected, also clearance between DDR signals is no 2.5 x trace width but only 2x trace width. Anyway , differential pair length matching is still stricly observed , also DDR length matching is also stricly observed with a total length of 26mm +- 0.2mm for all signals .
     <br/>
     With these PCB parameters , the manufacture cost dropped to 120USD including a gold finish for all the contacts.
     <br/>
     Finally , i received the PCB samples (they where of admirable perfect qualtity, i think the manufacturer have far better manufacture tolerance that it say) , assembled a board in 1 day and tested
     <br/>
     1- The FPGA configuration and flash memory : Works perfectly in 1x and 2x SPI bus but no 4x bus , i currently don't konw why.
     <br/>
     2- PCI express . Works perfectly . The Xilinx  core generator automatically produce a sample core application that is a PCI express device of type 'RAM controller".
     <br/>
     3- DDR3 : Works . Tests at 300Mhz clock (The core uses internally 2x this frequency using a PLL to double it).
     <br/>
     Now many other things should be tested :
     <br/>
     -SATA host and device connectors
     <br/>
     -SDHC memory cards
     <br/>
     -DDR3 and PCIE with a real intensive application . Like for example Linux why not!
     <br/>
     The card is at my knowledge one of the first design not from a commercial company, and i propose the PCB for anyone interested. And also the Altium designer project source (PCB and schematic) in download section.
     <br/>
     in case the PCB would be re - made , it would be a good idea to add a termination resistor on DRAM CLK differential pair. Yes it is not currently done, but it works! It could be still possible to solder it on the vias under the RAM chip.
     <br/>
     <br/>
    </p>
   </div>
   <div id="d_DDR3 extensive test with Microblaze FPGA processor">
    <h2>
     
     
     DDR3 extensive test with Microblaze FPGA processor
    </h2>
    <p id="p_DDR3 extensive test with Microblaze FPGA processor">
     I have learned what's required to setup microblaze on this board (processor running on Xilinx FPGA).
     <br/>
     Many documentation can be found from Xilinx but also from AVNET .
     <br/>
     A EDK licence is also required (Webpack free licence does not currently cover the full use of Xilinx SDK and Platform studio). By chance , they is a 30 day free evaluation licence for these products).
     <br/>
     <br/>
     Setting up Microblaze is fairly fast and straightforward, nearly all project generation is automated with option wizards where you specify what's is on the target board. The result is a SDK project with commands like "Download microblaze to FPGA" and "Run or Debug application project". All of that is done with the JTAG cable connected.
     <br/>
     <br/>
     I have specifically ran the DDR3 test application included with EDK basic application which extensively test the Memory by writing all the 128Mbyte memory locations then read and compare with expected value previously written. This test is performed with many flavor (Write constant value 0xFFFFFFFF,Write constant value 0x00000000,Write constant value 0xAAAA5555,Write incremented serie 1,2,3,..,0x0200000,Write inverse address as value,Write a rotated serie of 00..1..00 or 11..0..11.
     <br/>
     Here is the a portion of the C application and the result shows that DDR3 on this card is working correctly .
     <br/>
     Each run of  writing and reading the 128Mbyte take approx 30s. The microblaze processor is clocked at 100Mhz.
     <br/>
     int main()
     <br/>
     {
     <br/>
     int i;
     <br/>
     init_platform();
     <br/>
     print("--Starting Memory Test Application--\n\r");
     <br/>
     print("NOTE: This application runs with D-Cache disabled.");
     <br/>
     print("As a result, cacheline requests will not be generated\n\r");
     <br/>
     for (i = 0; i         test_memory_range(&amp;memory_ranges[i]);
     <br/>
     }
     <br/>
     print("--Memory Test Application Complete--\n\r");
     <br/>
     cleanup_platform();
     <br/>
     return 2;
     <br/>
     }
     <br/>
     <br/>
     --Starting Memory Test Application--
     <br/>
     NOTE: This application runs with D-Cache disabled.As a result, cacheline requests will not be generated
     <br/>
     Testing memory region: mcb_ddr3
     <br/>
     Memory Controller: axi_s6_ddrx
     <br/>
     Base Address: 0xc0000000
     <br/>
     Size: 0x08000000 bytes
     <br/>
     memtest words: 0x02000000 words
     <br/>
     0xFFFFFFFF test: PASSED!
     <br/>
     0x00000000 test: PASSED!
     <br/>
     incr test: PASSED!
     <br/>
     inverse addr test: PASSED!
     <br/>
     0xAAAA5555 test: PASSED!
     <br/>
     walk ones: PASSED!
     <br/>
     walk zeros: PASSED!
     <br/>
     --Memory Test Application Complete-
     <br/>
    </p>
   </div>
   <div id="d_Running Linux on the board">
    <h2>
     
     
     Running Linux on the board
    </h2>
    <p id="p_Running Linux on the board">
     I have compiled a Petalinux kernel for this board.
See download section for instruction of how to do that.

The compilation results include a image.elf that is a Linux with and embedded RAM filesystem.
It is possible to setup various configurations based on Linux.

It is planned an expansion board with Ethernet, USB host , Serial and maybe VGA output.
     <br/>
     <br/>
     <img src="usercontent,img,1364688996" alt="Petalinux"/>
    </p>
   </div>
   <div id="d_Credit">
    <h2>
     
     
     Credit
    </h2>
    <p id="p_Credit">
     PCB manufacturer for this card can be contacted at maisuid@gmail.com . dont hesitate to submit him your project for quote.
    </p>
   </div>
   <div id="d_Project update">
    <h2>
     
     
     Project update
    </h2>
    <p id="p_Project update">
     07-2014 . 3 new boards where built
     <br/>
     <img src="usercontent,img,1406320172" alt="project main"/>
     <br/>
     All worked properly without problem.
     <br/>
     The feature tested where :
     <br/>
     -FPGA, JTAG and Power supply
     <br/>
     -Flash memory
     <br/>
     -IO connectors, board leds and oscillator
     <br/>
     -PCI express
     <br/>
     -DDR3 (when installed)
     <br/>
     <br/>
     <img src="usercontent,img,1406379363" alt="Soldering"/>
     <br/>
     Example Linux / Windows drivers for PCIe where added to the download . An XPS design without Microblaze processor (only PCIe to peripherals bus) was added.  Example PCIe drivers for Windows and Linux are proposed in Xilinx xapp1052. A "no driver" approach is possible with Jungo windriver under Windows and with open/mmap (on PCIe BAR resource) under Linux.
    </p>
   </div>
  </div>
  <div style="clear:both;margin-left:200px;">
  </div>
 </div>
</div>
</body>
<p id='foot'>Database updated on 03 June 2015 by freerangefactory.org</p>
