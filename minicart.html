<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>PayPal minicart with weight-based shipping cost calculation</title>
</head>
<body>
  <h2>PAYPAL MINICART WITH WEIGHT-BASED SHIPPING</h2>
  <p>This cose shows the use of PayPal Minicart (minicartjs.com) with final
    shipping cost based on total freight weight. The formula
    for the final shipping fee calculation is in the code:</p>
  <p>
    shipping_cost = 12.00 + (shipping_weight_g / 1E3) * 6.50
  </p>

  <div id="PayPalMiniCart">
    <form action="https://www.paypal.com/cgi-bin/webscr" method="post">
      <input type="hidden" name="cmd" value="_cart" />
      <input type="hidden" name="add" value="1" />
      <input type="hidden" name="business" value="example@minicartjs.com" />
      <input type="hidden" name="item_name" value="Test Product One" />
      <input type="hidden" name="item_number" value="ref. 04465462" />
      <input type="hidden" name="quantity" value="1" />
      <input type="hidden" name="amount" value="3.18" />
      <input type="hidden" name="currency_code" value="USD" />
      <input type="hidden" name="weight_g" value="24">
      <strong>Test Product One: US$ 3.18, 24g. </strong>
      <input type="submit" name="submit" value="BUY NOW" />
    </form>
  </div>

  <div id="PayPalMiniCart">
    <form action="https://www.paypal.com/cgi-bin/webscr" method="post">
      <input type="hidden" name="cmd" value="_cart" />
      <input type="hidden" name="add" value="1" />
      <input type="hidden" name="business" value="example@minicartjs.com" />
      <input type="hidden" name="item_name" value="Test Product Two" />
      <input type="hidden" name="item_number" value="ref. 8766124" />
      <input type="hidden" name="quantity" value="1" />
      <input type="hidden" name="amount" value="13.33" />
      <input type="hidden" name="currency_code" value="USD" />
      <input type="hidden" name="weight_g" value="185">
      <strong>Test Product Two: US$13.33, 185g. </strong>
      <input type="submit" name="submit" value="BUY NOW" />
    </form>
  </div>

  <span id="PayPalMiniCart_ViewCart"> <a href="#">MY CART</a></span>

</body>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/minicart/3.0.5/minicart.min.js"></script>
<script>

  /* render shopping cart and reposition on the right*/
  paypal.minicart.render();
  $('#PPMiniCart').css({"right":"10px","left":"auto"});

  // every time an item is removed calculate and update the cart shipping weight
  paypal.minicart.cart.on('remove', function(idx, product) {
    // do nothing if the item removed is the shipping cost
    if (product.get('item_name').contains("Shipping and Handling")) {
      return false;}
    update_cart_shipping_cost(idx, product);
  });

  // every time an item is removed calculate and update the cart shipping weight
  paypal.minicart.cart.on('add', function(idx, product) {
    // do nothing if the item added is the shipping cost
    if (product.get('item_name').contains("Shipping and Handling")) {
      return false;}
    update_cart_shipping_cost(idx, product);
  });

  function update_cart_shipping_cost(idx, product){
    /* delete any previous shipping charge item */
    var a, items = paypal.minicart.cart.items();
    for (var i = 0; i < items.length; i++) {
      if (items[i].get('item_name').contains("Shipping and Handling")) {
        paypal.minicart.cart.remove(i);
      }
    }

    /* get quantity and weight for each cart item and calculate total weight */
    var items = paypal.minicart.cart.items(),
      q = [], n1= [], w = 0;
    var forms = $('#PayPalMiniCart form'),
      shipping_weight_g = 0;
    for (var i = 0; i < items.length; i++) {
      q.push(items[i].get('quantity'));
      n=items[i].get('item_name'); //shopping cart item name
      // search for the corresponding weight
      for (var ii = 0; ii < forms.length; ii++) {
        if (n.contains(forms.children('input[name="item_name"]')[ii].value)){
          w = forms.children('input[name="weight_g"]')[ii].value;
          // total weight calculation
          shipping_weight_g += parseFloat(w * q[i]);
        }
      }
    }

    // calculate total shipping cost and add to cart
    // this formula is OK if you are based in Europe, you ship Internationally
    // and you chanrge ins US$.
    var shipping_cost = 12.00 + (shipping_weight_g / 1E3) * 6.50; // in US$
    if (shipping_weight_g > 0){
      shipping_cost = shipping_cost.toFixed(2);}
    else{
      shipping_cost = 0.00;}
    p = {
      "business": "example@minicartjs.com", "item_name": "Shipping and Handling",
      "item_number": "International Registered Mail", "amount": shipping_cost,
      "currency_code": "USD"};
    paypal.minicart.cart.add(p);

    /* make quantity field not editable */
    $('#PPMiniCart .minicart-quantity').attr("disabled", true);

    /* hide shipping cost item quantity and delete button*/
    $("#PPMiniCart .minicart-item").each(function() {
        if ($(this).find('a').text() == "Shipping and Handling"){
        $(this).find('input').css('visibility','hidden');
        $(this).find('button').css('visibility','hidden');
      }
    });
  }

  /* show shopping cart*/
  $('#PayPalMiniCart_ViewCart a').click(function(e) {
    e.stopPropagation();
    paypal.minicart.view.show();

    /* make all quantity field not editable */
    $('#PPMiniCart .minicart-quantity').attr("disabled", true);

    /* hide shipping cost item quantity and delete button*/
    $("#PPMiniCart .minicart-item").each(function() {
        if ($(this).find('a').text() == "Shipping and Handling"){
        $(this).find('input').css('visibility','hidden');
        $(this).find('button').css('visibility','hidden');
      }
    });
  });
</script>
</html>
